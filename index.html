<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetegramNews24</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            min-height: 100vh;
        }
        
        /* HEADER */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 1.3em;
            margin: 0;
        }

        /* VIDEO PLAYER */
        .video-container {
            background: #000;
            margin: 0;
        }
        #video-player {
            width: 100%;
            height: 250px;
            background: #000;
            display: block;
        }

        /* CHANNEL LIST - SEMPRE VISIBILE */
        .channel-list {
            padding: 20px 15px;
            background: #111;
        }
        .channel-btn {
            background: #333;
            border: none;
            border-radius: 10px;
            padding: 15px;
            color: white;
            margin-bottom: 10px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
        }
        .channel-btn:hover {
            background: #444;
        }
        .channel-btn.playing {
            background: #667eea;
            border: 2px solid #fff;
        }
        .channel-name {
            font-size: 1.1em;
            font-weight: bold;
        }
        .channel-desc {
            font-size: 0.9em;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* SEARCH */
        .search-container {
            padding: 10px 15px;
            background: #222;
        }
        #search-input {
            width: 100%;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            background: #333;
            color: white;
            font-size: 1em;
        }

        /* CATEGORIES */
        .categories {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: #222;
            overflow-x: auto;
        }
        .category-btn {
            background: #333;
            border: none;
            border-radius: 15px;
            padding: 8px 15px;
            color: white;
            font-size: 0.8em;
            white-space: nowrap;
            cursor: pointer;
        }
        .category-btn.active {
            background: #667eea;
        }

        /* LOADING */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .hidden {
            display: none;
        }

        /* MESSAGE */
        .message {
            background: #333;
            padding: 15px;
            margin: 10px 15px;
            border-radius: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <h1>📺 RetegramNews24</h1>
    </div>

    <!-- VIDEO PLAYER SEMPRE VISIBILE -->
    <div class="video-container">
        <video 
            id="video-player" 
            controls 
            autoplay 
            playsinline
            poster="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjI1MCIgdmlld0JveD0iMCAwIDQwMCAyNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMjUwIiBmaWxsPSIjMTExIi8+CjxjaXJjbGUgY3g9IjIwMCIgY3k9IjEyNSIgcj0iMzAiIGZpbGw9IiM2NjciLz4KPHBhdGggZD0iTTE3MCAxMDBMMTcwIDE1MEwyMTAgMTI1WiIgZmlsbD0id2hpdGUiLz4KPHRleHQgeD0iMjAwIiB5PSIyMDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM4ODgiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtZmFtaWx5PSJBcmlhbCI+U2VsZXppb25hIHVuIGNhbmFsZTwvdGV4dD4KPC9zdmc+"
        >
            Il tuo browser non supporta il tag video.
        </video>
    </div>

    <!-- MESSAGGIO INFORMATIVO -->
    <div class="message">
        🎥 Seleziona un canale qui sotto. Alcuni stream potrebbero non funzionare.
    </div>

    <!-- SEARCH -->
    <div class="search-container">
        <input type="text" id="search-input" placeholder="🔍 Cerca canale..." onkeyup="filterChannels()">
    </div>

    <!-- CATEGORIES -->
    <div class="categories">
        <button class="category-btn active" onclick="filterByCategory('all')">Tutti</button>
        <button class="category-btn" onclick="filterByCategory('news')">News</button>
        <button class="category-btn" onclick="filterByCategory('sports')">Sport</button>
        <button class="category-btn" onclick="filterByCategory('music')">Musica</button>
        <button class="category-btn" onclick="filterByCategory('entertainment')">TV</button>
        <button class="category-btn" onclick="filterByCategory('weather')">Meteo</button>
    </div>

    <!-- LOADING -->
    <div id="loading" class="loading hidden">
        <div style="text-align: center;">
            <div style="font-size: 3em; margin-bottom: 20px;">📡</div>
            <p style="font-size: 1.2em; margin-bottom: 10px;">Caricamento in corso...</p>
            <p style="opacity: 0.7;">Attendi qualche secondo</p>
        </div>
    </div>

    <!-- CHANNEL LIST - SEMPRE VISIBILE -->
    <div id="channel-list" class="channel-list">
        <!-- Canali generati automaticamente -->
    </div>

    <script>
        // Inizializza Telegram Web App
        if (typeof Telegram !== 'undefined') {
            Telegram.WebApp.expand();
        }

        // CANALI TESTATI E FUNZIONANTI
        const channels = [
            // CANALI FUNZIONANTI
            { name: "🌍 DW Deutsch", url: "https://dwamdstream102.akamaized.net/hls/live/2015525/dwstream102/index.m3u8", category: "news", working: true },
            { name: "🎵 Retro Music TV", url: "https://stream.mediawork.cz/retrotv/smil:retrotv2.smil/playlist.m3u8", category: "music", working: true },
            { name: "🇹🇷 TRT World", url: "https://tv-trtworld.medya.trt.com.tr/master.m3u8", category: "news", working: true },
            { name: "🇶🇦 Qatar TV", url: "https://qatartv.akamaized.net/hls/live/2026573/qtv1/master.m3u8", category: "news", working: true },
            { name: "🇧🇬 TV1 Bulgaria", url: "https://tv1.cloudcdn.bg/temp/livestream.m3u8", category: "entertainment", working: true },
            { name: "🇨🇿 Óčko Music", url: "https://ocko-live.ssl.cdn.cra.cz/channels/ocko/playlist.m3u8", category: "music", working: true },
            { name: "📺 Junior TV", url: "https://5f22d76e220e1.streamlock.net/iuniortv/iuniortv/playlist.m3u8", category: "entertainment", working: true },
            
            // CANALI CON LINK ESTERNI (fallback)
            { name: "🇺🇸 CNN International", url: "https://edition.cnn.com/international", category: "news", working: false, external: true },
            { name: "🇺🇸 Fox News", url: "https://www.foxnews.com", category: "news", working: false, external: true },
            { name: "🌍 Al Jazeera", url: "https://www.aljazeera.com/live", category: "news", working: false, external: true },
            { name: "🇦🇺 Sky News Australia", url: "https://www.skynews.com.au", category: "news", working: false, external: true },
            { name: "🇺🇸 Bloomberg", url: "https://www.bloomberg.com/live", category: "news", working: false, external: true },
            { name: "🌤️ Fox Weather", url: "https://www.foxweather.com/live", category: "weather", working: false, external: true },
            { name: "🇦🇱 A2 News Albania", url: "https://a2news.com/live", category: "news", working: false, external: true },
            { name: "🇮🇹 LA7", url: "https://www.la7.it/dirette", category: "entertainment", working: false, external: true },
            { name: "🇪🇺 Euronews", url: "https://www.euronews.com/live", category: "news", working: false, external: true },
            { name: "🌤️ Accu Weather", url: "https://www.accuweather.com", category: "weather", working: false, external: true },
            { name: "🇺🇸 ABC News", url: "https://abcnews.go.com/Live", category: "news", working: false, external: true },
            { name: "🇷🇺 RT Español", url: "https://actualidad.rt.com/en_vivo", category: "news", working: false, external: true },
            { name: "🇺🇸 CBS News", url: "https://www.cbsnews.com/live", category: "news", working: false, external: true },
            { name: "🔬 Discovery Channel", url: "https://www.discovery.com", category: "entertainment", working: false, external: true },
            { name: "🇵🇹 RTP1 Portugal", url: "https://www.rtp.pt/play/direto/rtp1", category: "entertainment", working: false, external: true },
            { name: "🐾 Pet TV", url: "https://thepetcollective.tv", category: "entertainment", working: false, external: true },
            { name: "🇫🇷 RT France", url: "https://francais.rt.com/live", category: "news", working: false, external: true }
        ];

        const videoPlayer = document.getElementById('video-player');
        const channelList = document.getElementById('channel-list');
        const loading = document.getElementById('loading');
        
        let currentCategory = 'all';
        let currentSearch = '';
        let currentChannel = null;

        // GENERA LISTA CANALI
        function generateChannelList() {
            channelList.innerHTML = '';
            
            const filteredChannels = channels.filter(channel => {
                const matchesCategory = currentCategory === 'all' || channel.category === currentCategory;
                const matchesSearch = channel.name.toLowerCase().includes(currentSearch.toLowerCase());
                return matchesCategory && matchesSearch;
            });

            if (filteredChannels.length === 0) {
                channelList.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.7;">Nessun canale trovato</div>';
                return;
            }

            filteredChannels.forEach(channel => {
                const button = document.createElement('button');
                button.className = 'channel-btn';
                
                if (currentChannel && currentChannel.name === channel.name) {
                    button.classList.add('playing');
                }
                
                let statusIcon = channel.working ? '✅' : '🌐';
                if (currentChannel && currentChannel.name === channel.name) {
                    statusIcon = '▶️';
                }
                
                button.onclick = () => playStream(channel);
                
                button.innerHTML = `
                    <div class="channel-name">${statusIcon} ${channel.name}</div>
                    <div class="channel-desc">${getCategoryName(channel.category)} ${channel.external ? '(Link esterno)' : ''}</div>
                `;
                
                channelList.appendChild(button);
            });
        }

        function getCategoryName(category) {
            const categories = {
                'news': '📰 Notizie',
                'sports': '⚽ Sport', 
                'music': '🎵 Musica',
                'entertainment': '📺 TV',
                'weather': '🌤️ Meteo'
            };
            return categories[category] || 'Altro';
        }

        // PLAY STREAM MIGLIORATO
        function playStream(channel) {
            console.log("Tentativo di caricamento:", channel.name, channel.url);
            
            // Se è un link esterno, apri in nuova finestra
            if (channel.external) {
                window.open(channel.url, '_blank');
                return;
            }

            currentChannel = channel;
            
            // Mostra loading
            loading.classList.remove('hidden');
            
            // Aggiorna lista per mostrare "now playing"
            generateChannelList();

            // Ferma video precedente
            videoPlayer.pause();
            
            // Imposta nuova sorgente
            videoPlayer.src = channel.url;
            
            // Forza il caricamento
            videoPlayer.load();

            // Eventi per gestire il caricamento
            videoPlayer.oncanplay = function() {
                console.log("Video pronto:", channel.name);
                loading.classList.add('hidden');
                videoPlayer.play().catch(e => {
                    console.log("Auto-play fallito, ma video pronto");
                    loading.classList.add('hidden');
                });
            };
            
            videoPlayer.onplaying = function() {
                console.log("Riproduzione iniziata:", channel.name);
                loading.classList.add('hidden');
            };
            
            videoPlayer.onerror = function() {
                console.log("Errore video per:", channel.name);
                loading.classList.add('hidden');
                
                // Fallback: prova ad aprire il link esterno
                setTimeout(() => {
                    if (!videoPlayer.src || videoPlayer.error) {
                        alert(`❌ ${channel.name} non disponibile come stream diretto.\nVerrai reindirizzato al sito web.`);
                        window.open(channel.url, '_blank');
                    }
                }, 1000);
            };

            // Timeout di sicurezza
            setTimeout(function() {
                if (!loading.classList.contains('hidden')) {
                    console.log("Timeout per:", channel.name);
                    loading.classList.add('hidden');
                    
                    if (!videoPlayer.src || videoPlayer.error || videoPlayer.paused) {
                        alert(`⏱️ ${channel.name} sta impiegando troppo tempo.\nVerrai reindirizzato al sito web.`);
                        window.open(channel.url, '_blank');
                    }
                }
            }, 8000);
        }

        function filterChannels() {
            currentSearch = document.getElementById('search-input').value;
            generateChannelList();
        }

        function filterByCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            generateChannelList();
        }

        // GESTIONE ERRORI
        videoPlayer.addEventListener('error', function(e) {
            console.error('Errore video player:', videoPlayer.error);
        });

        // INIZIALIZZA L'APP
        generateChannelList();

        console.log("🎬 RetegramNews24 caricato con", channels.length, "canali");
        console.log("✅ Canali funzionanti:", channels.filter(c => c.working).length);
        console.log("🌐 Link esterni:", channels.filter(c => c.external).length);
    </script>
</body>
</html>
